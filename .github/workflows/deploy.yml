name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install IPFS
        run: |
          Invoke-WebRequest -Uri https://dist.ipfs.io/go-ipfs/v0.11.0/go-ipfs_v0.11.0_windows-amd64.zip -OutFile go-ipfs.zip
          Expand-Archive go-ipfs.zip -DestinationPath C:\tools\ipfs
          Start-Process -FilePath "C:\tools\ipfs\go-ipfs\install.bat" -ArgumentList "/silent" -Wait
          ipfs init  # Initialise un nouveau dépôt IPFS
          Start-Service ipfs  # Démarre le démon IPFS

      - name: Add files to IPFS
        run: |
          ipfs add -r .

      - name: Publish to Pinata
        run: |
          curl -X POST `
            -H "Content-Type: application/json" `
            -H "pinata_api_key: ${{ secrets.PINATA_API }}" `
            -H "pinata_secret_api_key: ${{ secrets.PINATA_API }}" `
            --data '{"cid": "QmeJaufp9seXCpHMFwxX53P3oRQW8Ny1DduCXAxebEwxv7"}' `
            https://api.pinata.cloud/pinning/pinByHash
